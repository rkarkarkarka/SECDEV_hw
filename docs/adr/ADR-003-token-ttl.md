# ADR-003: Access Token TTL Enforcement (15 minutes)
Дата: 2025-12-18
Статус: Accepted

## Context
По NFR-02 требуется, чтобы access-токены истекали максимум через 15 минут. Текущая реализация `AuthService` хранит токен → user_id без метаданных и никогда не инвалидирует токен по времени, что увеличивает последствия утечки токена (угроза F4, риск R5).

## Decision
- Изменяем `InMemoryDB.tokens` на хранение `{user_id, issued_at}`.
- `AuthService` читает TTL из `APP_TOKEN_TTL_SECONDS` (по умолчанию 900 секунд) и проверяет срок в `get_user_from_token`. Просроченные токены удаляются и возвращают `auth_error`.
- Тест `tests/test_auth.py::test_token_expires_after_ttl` вручную сдвигает `issued_at` и проверяет, что защищённый эндпойнт -> 401.
- Параметры TTL отражены в README/конфиге; в будущем планируется вынести в Redis/session store.

Альтернативы:
1. **JWT с `exp`** — self-contained, но требует подписи и ротации ключей; для MVP проще хранить серверное состояние.
2. **Refresh токены** — усложняют протокол; пока нет требований.
3. **Бесконечные токены** — проще, но нарушают NFR-02 и STRIDE.

## Consequences
- Выполняем NFR-02, уменьшаем окно атаки после утечки.
- Появляется дополнительная проверка на каждом запросе (небольшая стоимость).
- Потребуется миграция токен-хранилища при переходе на распределённую конфигурацию (пока in-memory).

## Links
- NFR-02 (TTL access-токена)
- Threat Model: F3/F4, Risk R5
- Тесты: `tests/test_auth.py::test_token_expires_after_ttl`
